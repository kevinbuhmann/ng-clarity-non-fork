name: PR Comment Bot
on:
  workflow_run:
    workflows: [PR Build]
jobs:
  pr-comment-bot:
    name: PR Comment Bot
    runs-on: ubuntu-latest
    steps:
      - name: Get PR Event
        id: get-pr-event
        uses: potiuk/get-workflow-origin@v1_3
        with:
          token: ${{secrets.GITHUB_TOKEN}}
          sourceRunId: ${{github.event.workflow_run.id}}

      # Clarity Release Bot
      - name: Find Comment
        id: find-comment
        uses: peter-evans/find-comment@v1
        with:
          issue-number: ${{steps.get-pr-event.outputs.pullRequestNumber}}
          comment-author: 'github-actions[bot]'
          body-includes: ğŸ¤– Clarity Release Bot
      - name: Build Started PR Comment
        if: ${{github.event.action == 'requested'}}
        uses: peter-evans/create-or-update-comment@v1
        with:
          comment-id: ${{steps.find-comment.outputs.comment-id}}
          issue-number: ${{steps.get-pr-event.outputs.pullRequestNumber}}
          body: |
            ğŸ‘‹ @${{github.event.sender.login}},

            * ğŸ™ The Clarity team thanks you for opening a pull request
            * â³ The build for this PR has started
            * ğŸ“« I'll update this comment when the build has finished

            Thank you,

            ğŸ¤– Clarity Release Bot
          edit-mode: replace
      - name: Build Succeeded PR Comment
        if: ${{github.event.workflow_run.conclusion == 'success'}}
        uses: peter-evans/create-or-update-comment@v1
        with:
          comment-id: ${{steps.find-comment.outputs.comment-id}}
          issue-number: ${{steps.get-pr-event.outputs.pullRequestNumber}}
          body: |
            ğŸ‘‹ @${{github.event.sender.login}},

            * ğŸ™ The Clarity team thanks you for opening a pull request
            * ğŸ‰ The build for this PR has succeeded
            * ğŸ” The PR is now ready for review
            * ğŸ¿ In the meantime, checkout out a [preview of this PR](https://${{steps.get-pr-event.outputs.pullRequestNumber}}--${{secrets.NETLIFY_SITE_NAME}}.netlify.app)
            * ğŸ– You can always follow up here. If you're a VMware employee, you can also reach us on our [internal #clarity-support Slack channel](https://vmware-clarity.slack.com/archives/C0JF8D2LB)

            Thank you,

            ğŸ¤– Clarity Release Bot
          edit-mode: replace
      - name: Build Failed PR Comment
        if: ${{github.event.workflow_run.conclusion == 'failure'}}
        uses: peter-evans/create-or-update-comment@v1
        with:
          comment-id: ${{steps.find-comment.outputs.comment-id}}
          issue-number: ${{steps.get-pr-event.outputs.pullRequestNumber}}
          body: |
            ğŸ‘‹ @${{github.event.sender.login}},

            * ğŸ˜­ The build for this PR has failed
            * ğŸ—’ Please check out the [build log](${{github.event.workflow_run.html_url}})
            * ğŸ– You can always follow up here. If you're a VMware employee, you can also reach us on our [internal #clarity-support Slack channel](https://vmware-clarity.slack.com/archives/C0JF8D2LB)

            Thank you,

            ğŸ¤– Clarity Release Bot
          edit-mode: replace

      # Clarity Visual Regression Test Bot
      - name: Find Comment (Visual Regression Test)
        id: find-visual-regression-test-bot-comment
        uses: peter-evans/find-comment@v1
        with:
          issue-number: ${{steps.get-pr-event.outputs.pullRequestNumber}}
          comment-author: 'github-actions[bot]'
          body-includes: ğŸ¤– Clarity Visual Regression Test Bot
      - name: Build Started PR Comment (Visual Regression Test)
        if: ${{github.event.action == 'requested'}}
        uses: peter-evans/create-or-update-comment@v1
        with:
          comment-id: ${{steps.find-visual-regression-test-bot-comment.outputs.comment-id}}
          issue-number: ${{steps.get-pr-event.outputs.pullRequestNumber}}
          body: |
            ğŸ‘‹ @${{github.event.sender.login}},

            * ğŸ™ The Clarity team thanks you for opening a pull request
            * â³ The visual regression test for this PR will start when the build finishes
            * ğŸ“« I'll update this comment when the visual regression test has started

            Thank you,

            ğŸ¤– Clarity Visual Regression Test Bot
          edit-mode: replace
      - name: Build Failed PR Comment (Visual Regression Test)
        if: ${{github.event.workflow_run.conclusion == 'failure'}}
        uses: peter-evans/create-or-update-comment@v1
        with:
          comment-id: ${{steps.find-visual-regression-test-bot-comment.outputs.comment-id}}
          issue-number: ${{steps.get-pr-event.outputs.pullRequestNumber}}
          body: |
            ğŸ‘‹ @${{github.event.sender.login}},

            * ğŸ˜­ The build for this PR has failed
            * ğŸ—’ Please fix the build failure in order to run the visual regression test

            Thank you,

            ğŸ¤– Clarity Visual Regression Test Bot
          edit-mode: replace
